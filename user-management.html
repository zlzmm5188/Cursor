<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç† - Providence èµ„é‡‘ç›˜åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            font-size: 14px;
            min-height: 100vh;
        }

        /* ç»Ÿä¸€Header */
        .top-header {
            background: #001529;
            color: white;
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .top-header h1 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .admin-info {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }

        /* ç»Ÿä¸€å¸ƒå±€ */
        .layout {
            display: flex;
            min-height: calc(100vh - 64px);
        }

        /* ç»Ÿä¸€ä¾§è¾¹æ  */
        .sidebar {
            width: 200px;
            background: #001529;
            color: white;
            padding: 16px 0;
        }
        .menu-item {
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255,255,255,0.85);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        .menu-item:hover {
            background: #1890ff;
            color: white;
        }
        .menu-item.active {
            background: #1890ff;
            color: white;
        }

        /* å†…å®¹åŒº */
        .content-wrapper {
            flex: 1;
            overflow-y: auto;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .toolbar {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #1890ff;
            color: #fff;
        }

        .btn-primary:hover {
            background: #40a9ff;
        }

        .btn-success {
            background: #52c41a;
            color: #fff;
        }

        .btn-danger {
            background: #ff4d4f;
            color: #fff;
        }

        .btn-warning {
            background: #faad14;
            color: #fff;
        }

        .search-box {
            display: flex;
            gap: 8px;
            flex: 1;
            max-width: 600px;
        }

        .search-box input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            background: #fff;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #8c8c8c;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .stat-card .change {
            font-size: 12px;
            margin-top: 8px;
        }

        .stat-card .change.up {
            color: #52c41a;
        }

        .stat-card .change.down {
            color: #ff4d4f;
        }

        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #fafafa;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            font-weight: 600;
            color: #595959;
            font-size: 13px;
        }

        td {
            color: #262626;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #fafafa;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .badge-danger {
            background: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }

        .badge-warning {
            background: #fffbe6;
            color: #faad14;
            border: 1px solid #ffe58f;
        }

        .badge-info {
            background: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }

        .badge-internal {
            background: #f9f0ff;
            color: #722ed1;
            border: 1px solid #d3adf7;
        }

        .action-btns {
            display: flex;
            gap: 4px;
        }

        .action-btns button {
            padding: 4px 8px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background: #fff;
            margin: 40px auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .close {
            font-size: 28px;
            font-weight: 300;
            color: #8c8c8c;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #262626;
        }

        .modal-body {
            padding: 24px;
            max-height: 600px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #595959;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            background: #fff;
            color: #262626;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #40a9ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .tree-view {
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            max-height: 600px;
            overflow: auto;
            position: relative;
        }

        .tree-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 300px;
        }

        .tree-node-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            margin: 12px;
            min-width: 220px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tree-node-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
        }

        .tree-node-card.level-0 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 3px solid #ffd700;
        }

        .tree-node-card.level-1 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .tree-node-card.level-2 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .tree-node-card.level-3 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .tree-node-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .tree-node-name {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tree-node-vip {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .tree-node-info {
            display: flex;
            gap: 16px;
            font-size: 13px;
            opacity: 0.95;
        }

        .tree-node-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tree-node-stat-label {
            font-size: 11px;
            opacity: 0.8;
        }

        .tree-node-stat-value {
            font-weight: 600;
            font-size: 14px;
        }

        .tree-children {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 24px;
            position: relative;
        }

        .tree-line {
            position: absolute;
            top: -24px;
            left: 50%;
            width: 2px;
            height: 24px;
            background: linear-gradient(180deg, #d9d9d9 0%, transparent 100%);
        }

        .tree-branch {
            position: relative;
        }

        .tree-branch::before {
            content: '';
            position: absolute;
            top: -24px;
            left: 50%;
            width: 2px;
            height: 24px;
            background: #d9d9d9;
        }

        .tree-level {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .tree-connector {
            position: absolute;
            top: -12px;
            width: 100%;
            height: 2px;
            background: #d9d9d9;
            left: 0;
        }

        .team-stats-panel {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .team-stat-card {
            background: #fff;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .team-stat-card .label {
            font-size: 12px;
            color: #8c8c8c;
            margin-bottom: 4px;
        }

        .team-stat-card .value {
            font-size: 20px;
            font-weight: 700;
            color: #1890ff;
        }

        #teamTree {
            min-height: 300px;
        }

        .empty-team {
            text-align: center;
            padding: 60px 20px;
            color: #8c8c8c;
        }

        .empty-team svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .login-log-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .login-log-item:last-child {
            border-bottom: none;
        }

        .login-log-item .time {
            font-weight: 600;
            color: #595959;
        }

        .login-log-item .device {
            color: #8c8c8c;
            font-size: 12px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 16px;
        }

        .pagination button {
            padding: 6px 12px;
            border: 1px solid #d9d9d9;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:hover:not(:disabled) {
            border-color: #40a9ff;
            color: #40a9ff;
        }

        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .pagination .current {
            padding: 6px 12px;
            background: #1890ff;
            color: #fff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- ç»Ÿä¸€Header -->
    <div class="top-header">
        <h1>ğŸ“Š Providence åå°ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="header-right">
            <span class="admin-info">ç®¡ç†å‘˜</span>
            <button class="btn" onclick="logout()" style="background: #ff4d4f; color: white; border: none;">é€€å‡º</button>
        </div>
    </div>

    <!-- ç»Ÿä¸€å¸ƒå±€ -->
    <div class="layout">
        <!-- ç»Ÿä¸€ä¾§è¾¹æ  -->
        <div class="sidebar">
            <a href="index.html" class="menu-item">ğŸ“Š æ•°æ®æ¦‚è§ˆ</a>
            <a href="user-management.html" class="menu-item active">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
            <div class="menu-item" onclick="alert('é¡¹ç›®ç®¡ç†åŠŸèƒ½')">ğŸ“ˆ é¡¹ç›®ç®¡ç†</div>
            <div class="menu-item" onclick="alert('è´¢åŠ¡ç®¡ç†åŠŸèƒ½')">ğŸ’° è´¢åŠ¡ç®¡ç†</div>
            <div class="menu-item" onclick="alert('å®åè®¤è¯åŠŸèƒ½')">ğŸ†” å®åè®¤è¯</div>
            <div class="menu-item" onclick="alert('ç³»ç»Ÿè®¾ç½®åŠŸèƒ½')">âš™ï¸ ç³»ç»Ÿè®¾ç½®</div>
            <div class="menu-item" onclick="alert('æ“ä½œæ—¥å¿—åŠŸèƒ½')">ğŸ“‹ æ“ä½œæ—¥å¿—</div>
        </div>

        <!-- å†…å®¹åŒº -->
        <div class="content-wrapper">
            <div class="container">
                <div class="header">
                    <h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
                </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-cards">
            <div class="stat-card">
                <h3>æ€»ç”¨æˆ·æ•°</h3>
                <div class="value" id="totalUsers">0</div>
                <div class="change up">â†‘ è¾ƒæ˜¨æ—¥ +0</div>
            </div>
            <div class="stat-card">
                <h3>æ­£å¸¸ç”¨æˆ·</h3>
                <div class="value" id="activeUsers">0</div>
                <div class="change up">çŠ¶æ€æ­£å¸¸</div>
            </div>
            <div class="stat-card">
                <h3>å†»ç»“ç”¨æˆ·</h3>
                <div class="value" id="frozenUsers">0</div>
                <div class="change down">éœ€å…³æ³¨</div>
            </div>
            <div class="stat-card">
                <h3>å†…éƒ¨ç”¨æˆ·</h3>
                <div class="value" id="internalUsers">0</div>
                <div class="change">ä¸è®¡å…¥ç»Ÿè®¡</div>
            </div>
        </div>

        <!-- å·¥å…·æ  -->
        <div class="toolbar">
            <button class="btn btn-primary" onclick="showAddUserModal()">â• æ·»åŠ ç”¨æˆ·</button>
            <button class="btn btn-success" onclick="exportUsers()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>

            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ·åã€IDã€æ‰‹æœºå·..." onkeyup="searchUsers(event)">
                <button class="btn btn-primary" onclick="searchUsers()">ğŸ” æœç´¢</button>
            </div>

            <div class="filter-group">
                <select id="vipFilter" onchange="filterUsers()">
                    <option value="">å…¨éƒ¨VIP</option>
                    <option value="0">VIP0</option>
                    <option value="1">VIP1</option>
                    <option value="2">VIP2</option>
                    <option value="3">VIP3</option>
                    <option value="4">VIP4</option>
                    <option value="5">VIP5</option>
                    <option value="6">VIP6</option>
                    <option value="7">VIP7</option>
                    <option value="8">VIP8</option>
                </select>
                <select id="internalFilter" onchange="filterUsers()">
                    <option value="">å…¨éƒ¨ç±»å‹</option>
                    <option value="0">æ™®é€šç”¨æˆ·</option>
                    <option value="1">å†…éƒ¨ç”¨æˆ·</option>
                </select>
            </div>
        </div>

        <!-- ç”¨æˆ·åˆ—è¡¨ -->
        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>VIPç­‰çº§</th>
                            <th>ç±»å‹</th>
                            <th>CNYä½™é¢</th>
                            <th>USDTä½™é¢</th>
                            <th>ç´¯è®¡æŠ•èµ„</th>
                            <th>å›¢é˜Ÿäººæ•°</th>
                            <th>æ¨èäºº</th>
                            <th>çŠ¶æ€</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="userTable">
                        <tr>
                            <td colspan="12" style="text-align: center; padding: 40px; color: #8c8c8c;">
                                åŠ è½½ä¸­...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ·»åŠ ç”¨æˆ·</h2>
                <span class="close" onclick="closeModal('userModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">

                    <div class="form-row">
                        <div class="form-group">
                            <label>ç”¨æˆ·å *</label>
                            <input type="text" id="username" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                        </div>
                        <div class="form-group">
                            <label>å¯†ç  *</label>
                            <input type="password" id="password" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>çœŸå®å§“å</label>
                            <input type="text" id="realname" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
                        </div>
                        <div class="form-group">
                            <label>VIPç­‰çº§</label>
                            <select id="vipLevel">
                                <option value="0">VIP0</option>
                                <option value="1">VIP1</option>
                                <option value="2">VIP2</option>
                                <option value="3">VIP3</option>
                                <option value="4">VIP4</option>
                                <option value="5">VIP5</option>
                                <option value="6">VIP6</option>
                                <option value="7">VIP7</option>
                                <option value="8">VIP8</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>CNYä½™é¢</label>
                            <input type="number" id="balanceCny" value="0" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label>USDTä½™é¢</label>
                            <input type="number" id="balanceUsdt" value="0" step="0.01" min="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>æ¨èäººID</label>
                            <input type="number" id="inviterId" value="0" placeholder="0è¡¨ç¤ºæ— æ¨èäºº">
                        </div>
                        <div class="form-group">
                            <label>é‚€è¯·ç </label>
                            <input type="text" id="inviteCode" placeholder="è‡ªåŠ¨ç”Ÿæˆ8ä½æ•°å­—">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>è´¦æˆ·çŠ¶æ€</label>
                            <select id="userStatus">
                                <option value="1">æ­£å¸¸</option>
                                <option value="0">å†»ç»“</option>
                            </select>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="isInternal">
                            <label>å†…éƒ¨ç”¨æˆ·ï¼ˆä¸è®¡å…¥æŠ•èµ„ç»Ÿè®¡ï¼‰</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('userModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveUser()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å›¢é˜Ÿå…³ç³»å›¾æ¨¡æ€æ¡† -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>å›¢é˜Ÿå…³ç³»å›¾</h2>
                <span class="close" onclick="closeModal('teamModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="teamTree" class="tree-view">
                    <div style="text-align: center; padding: 40px; color: #8c8c8c;">
                        åŠ è½½ä¸­...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('teamModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ç™»å½•è®°å½•æ¨¡æ€æ¡† -->
    <div id="loginLogModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç™»å½•è®°å½•</h2>
                <span class="close" onclick="closeModal('loginLogModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="loginLogList">
                    <div style="text-align: center; padding: 40px; color: #8c8c8c;">
                        åŠ è½½ä¸­...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('loginLogModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // ç”Ÿäº§ç¯å¢ƒAPIåœ°å€
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8082/api'  // å¼€å‘ç¯å¢ƒ
            : 'https://api.4kp3l0iq.top/api';  // ç”Ÿäº§ç¯å¢ƒ
        let currentPage = 1;
        let pageSize = 20;
        let allUsers = [];
        let filteredUsers = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
        });

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            try {
                const result = await AdminAPI.get('/providence/users');

                if (result.code === 1) {
                    // åªä¿ç•™æ­£å¸¸ç”¨æˆ·ï¼Œè¿‡æ»¤æ‰å†»ç»“ç”¨æˆ·
                    allUsers = (result.data || []).filter(u => u.status == 1);
                    filteredUsers = allUsers;
                    updateStats();
                    renderUsers();
                } else {
                    alert('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥ï¼š' + result.msg);
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
            }
        }

        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        function updateStats() {
            // åªç»Ÿè®¡æ­£å¸¸ç”¨æˆ·ï¼ˆæ’é™¤å†»ç»“ç”¨æˆ·ï¼‰
            const activeUsers = allUsers.filter(u => u.status == 1);
            const total = activeUsers.length;
            const internal = activeUsers.filter(u => u.is_internal == 1).length;
            const normal = activeUsers.filter(u => u.is_internal == 0).length;

            document.getElementById('totalUsers').textContent = total;
            document.getElementById('activeUsers').textContent = normal;
            document.getElementById('frozenUsers').textContent = 0; // ä¸æ˜¾ç¤ºå†»ç»“ç”¨æˆ·
            document.getElementById('internalUsers').textContent = internal;
        }

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUsers() {
            const tbody = document.getElementById('userTable');
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageUsers = filteredUsers.slice(start, end);

            if (pageUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 40px; color: #8c8c8c;">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = pageUsers.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>
                        <strong>${user.username}</strong>
                        ${user.is_internal == 1 ? '<span class="badge badge-internal">å†…éƒ¨</span>' : ''}
                    </td>
                    <td><span class="badge badge-info">VIP${user.vip_level}</span></td>
                    <td>${user.is_internal == 1 ? 'å†…éƒ¨ç”¨æˆ·' : 'æ™®é€šç”¨æˆ·'}</td>
                    <td>Â¥${parseFloat(user.balance_cny || 0).toLocaleString()}</td>
                    <td>${parseFloat(user.balance_usdt || 0).toFixed(2)} USDT</td>
                    <td>Â¥${parseFloat(user.total_investment || 0).toLocaleString()}</td>
                    <td>${user.team_count || 0}äºº</td>
                    <td>${user.inviter_id > 0 ? `ID: ${user.inviter_id}` : '-'}</td>
                    <td>
                        ${user.status == 1 ?
                            '<span class="badge badge-success">æ­£å¸¸</span>' :
                            '<span class="badge badge-danger">å†»ç»“</span>'}
                    </td>
                    <td>${formatDate(user.create_time)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-primary" onclick="editUser(${user.id})">ç¼–è¾‘</button>
                            <button class="btn btn-warning" onclick="viewTeam(${user.id})">å›¢é˜Ÿ</button>
                            <button class="btn btn-info" onclick="viewLoginLog(${user.id})">æ—¥å¿—</button>
                            <button class="btn btn-danger" onclick="freezeUser(${user.id})">å†»ç»“</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            renderPagination();
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination() {
            const totalPages = Math.ceil(filteredUsers.length / pageSize);
            const pagination = document.getElementById('pagination');

            let html = '<button onclick="changePage(-1)" ' + (currentPage === 1 ? 'disabled' : '') + '>ä¸Šä¸€é¡µ</button>';
            html += `<span class="current">ç¬¬ ${currentPage} / ${totalPages} é¡µ</span>`;
            html += '<button onclick="changePage(1)" ' + (currentPage >= totalPages ? 'disabled' : '') + '>ä¸‹ä¸€é¡µ</button>';

            pagination.innerHTML = html;
        }

        // åˆ‡æ¢é¡µé¢
        function changePage(delta) {
            currentPage += delta;
            renderUsers();
        }

        // æœç´¢ç”¨æˆ·
        function searchUsers(event) {
            if (event && event.keyCode !== 13) return;

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            if (!searchTerm) {
                filteredUsers = allUsers;
            } else {
                filteredUsers = allUsers.filter(user =>
                    user.username.toLowerCase().includes(searchTerm) ||
                    user.id.toString().includes(searchTerm) ||
                    (user.phone && user.phone.includes(searchTerm))
                );
            }

            currentPage = 1;
            filterUsers();
        }

        // è¿‡æ»¤ç”¨æˆ·
        function filterUsers() {
            const vipFilter = document.getElementById('vipFilter').value;
            const internalFilter = document.getElementById('internalFilter').value;

            filteredUsers = allUsers.filter(user => {
                // åªæ˜¾ç¤ºæ­£å¸¸ç”¨æˆ·
                if (user.status != 1) return false;
                if (vipFilter !== '' && user.vip_level != vipFilter) return false;
                if (internalFilter !== '' && user.is_internal != internalFilter) return false;
                return true;
            });

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(user =>
                    user.username.toLowerCase().includes(searchTerm) ||
                    user.id.toString().includes(searchTerm)
                );
            }

            currentPage = 1;
            renderUsers();
        }

        // æ˜¾ç¤ºæ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡†
        function showAddUserModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ ç”¨æˆ·';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('password').required = true;
            document.getElementById('userModal').style.display = 'block';
        }

        // ç¼–è¾‘ç”¨æˆ·
        async function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ç”¨æˆ·';
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('password').value = '';
            document.getElementById('password').required = false;
            document.getElementById('realname').value = user.realname || '';
            document.getElementById('vipLevel').value = user.vip_level;
            document.getElementById('balanceCny').value = user.balance_cny;
            document.getElementById('balanceUsdt').value = user.balance_usdt;
            document.getElementById('inviterId').value = user.inviter_id;
            document.getElementById('inviteCode').value = user.invite_code || '';
            document.getElementById('userStatus').value = user.status;
            document.getElementById('isInternal').checked = user.is_internal == 1;
            document.getElementById('userModal').style.display = 'block';
        }

        // ä¿å­˜ç”¨æˆ·
        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }

            if (!userId && !password) {
                alert('æ·»åŠ æ–°ç”¨æˆ·æ—¶å¿…é¡»è®¾ç½®å¯†ç ');
                return;
            }

            const data = {
                username,
                password,
                realname: document.getElementById('realname').value,
                vip_level: document.getElementById('vipLevel').value,
                balance_cny: document.getElementById('balanceCny').value,
                balance_usdt: document.getElementById('balanceUsdt').value,
                inviter_id: document.getElementById('inviterId').value,
                invite_code: document.getElementById('inviteCode').value,
                status: document.getElementById('userStatus').value,
                is_internal: document.getElementById('isInternal').checked ? 1 : 0
            };

            try {
                let result;
                if (userId) {
                    result = await AdminAPI.post(`/providence/users/${userId}/balance`, data);
                } else {
                    // åˆ›å»ºç”¨æˆ·éœ€è¦è°ƒç”¨ä¸åŒçš„APIï¼Œè¿™é‡Œå…ˆæç¤º
                    alert('åˆ›å»ºç”¨æˆ·åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒï¼Œè¯·è”ç³»å¼€å‘äººå‘˜');
                    return;
                }

                if (result.code === 1) {
                    alert(userId ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ');
                    closeModal('userModal');
                    loadUsers();
                } else {
                    alert(result.msg || 'æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        // å†»ç»“ç”¨æˆ·
        async function freezeUser(userId) {
            if (!confirm('ç¡®å®šè¦å†»ç»“è¯¥ç”¨æˆ·å—ï¼Ÿ')) return;

            try {
                const result = await AdminAPI.post(`/providence/users/${userId}/status`, {
                    status: 0
                });

                if (result.code === 1) {
                    alert('å†»ç»“æˆåŠŸ');
                    loadUsers();
                } else {
                    alert(result.msg || 'å†»ç»“å¤±è´¥');
                }
            } catch (error) {
                alert('å†»ç»“å¤±è´¥');
            }
        }

        // è§£å†»ç”¨æˆ·
        async function unfreezeUser(userId) {
            if (!confirm('ç¡®å®šè¦è§£å†»è¯¥ç”¨æˆ·å—ï¼Ÿ')) return;

            try {
                const result = await AdminAPI.post(`/providence/users/${userId}/status`, {
                    status: 1
                });

                if (result.code === 1) {
                    alert('è§£å†»æˆåŠŸ');
                    loadUsers();
                } else {
                    alert(result.msg || 'è§£å†»å¤±è´¥');
                }
            } catch (error) {
                alert('è§£å†»å¤±è´¥');
            }
        }

        // æŸ¥çœ‹å›¢é˜Ÿå…³ç³»
        async function viewTeam(userId) {
            document.getElementById('teamModal').style.display = 'block';
            document.getElementById('teamTree').innerHTML = '<div style="text-align: center; padding: 40px; color: #8c8c8c;">åŠ è½½ä¸­...</div>';

            try {
                // å›¢é˜Ÿæ ‘APIéœ€è¦ç¡®è®¤åç«¯è·¯ç”±
                const result = await AdminAPI.get(`/providence/users/${userId}`);
                // å¦‚æœåç«¯æ²¡æœ‰å›¢é˜Ÿæ ‘æ¥å£ï¼Œä½¿ç”¨ç”¨æˆ·è¯¦æƒ…ä¸­çš„å›¢é˜Ÿä¿¡æ¯

                if (result.code === 1) {
                    renderTeamTree(result.data);
                } else {
                    document.getElementById('teamTree').innerHTML = '<div style="text-align: center; padding: 40px; color: #ff4d4f;">åŠ è½½å¤±è´¥</div>';
                }
            } catch (error) {
                document.getElementById('teamTree').innerHTML = '<div style="text-align: center; padding: 40px; color: #ff4d4f;">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ¸²æŸ“å›¢é˜Ÿæ ‘
        function renderTeamTree(data) {
            const tree = document.getElementById('teamTree');

            if (!data || !data.user) {
                tree.innerHTML = `
                    <div class="empty-team">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        <div>æš‚æ— å›¢é˜Ÿæ•°æ®</div>
                    </div>
                `;
                return;
            }

            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            function calculateStats(user) {
                let totalMembers = 0;
                let totalInvestment = 0;
                let maxLevel = 0;

                function traverse(node, level = 0) {
                    totalMembers++;
                    totalInvestment += parseFloat(node.total_investment || 0);
                    maxLevel = Math.max(maxLevel, level);

                    if (node.children && node.children.length > 0) {
                        node.children.forEach(child => traverse(child, level + 1));
                    }
                }

                traverse(user);
                return { totalMembers, totalInvestment, maxLevel };
            }

            const stats = calculateStats(data.user);

            // æ„å»ºç»Ÿè®¡é¢æ¿
            let statsHtml = `
                <div class="team-stats-panel">
                    <div class="team-stat-card">
                        <div class="label">å›¢é˜Ÿæ€»äººæ•°</div>
                        <div class="value">${stats.totalMembers}</div>
                    </div>
                    <div class="team-stat-card">
                        <div class="label">å›¢é˜Ÿæ€»æŠ•èµ„</div>
                        <div class="value">Â¥${stats.totalInvestment.toLocaleString()}</div>
                    </div>
                    <div class="team-stat-card">
                        <div class="label">æœ€å¤§å±‚çº§</div>
                        <div class="value">${stats.maxLevel + 1}çº§</div>
                    </div>
                    <div class="team-stat-card">
                        <div class="label">ç›´æ¨äººæ•°</div>
                        <div class="value">${data.user.children ? data.user.children.length : 0}äºº</div>
                    </div>
                </div>
            `;

            // æ„å»ºæ ‘å½¢ç»“æ„
            function buildTreeNode(user, level = 0) {
                const levelClass = `level-${Math.min(level, 3)}`;
                const childCount = user.children ? user.children.length : 0;

                let html = `
                    <div class="tree-node-card ${levelClass}">
                        <div class="tree-node-header">
                            <div class="tree-node-name">
                                ${level === 0 ? 'ğŸ‘‘ ' : ''}${user.username}
                                <span class="tree-node-vip">VIP${user.vip_level}</span>
                            </div>
                        </div>
                        <div class="tree-node-info">
                            <div class="tree-node-stat">
                                <div class="tree-node-stat-label">ç´¯è®¡æŠ•èµ„</div>
                                <div class="tree-node-stat-value">Â¥${parseFloat(user.total_investment || 0).toLocaleString()}</div>
                            </div>
                            <div class="tree-node-stat">
                                <div class="tree-node-stat-label">å›¢é˜Ÿäººæ•°</div>
                                <div class="tree-node-stat-value">${user.team_count || childCount}äºº</div>
                            </div>
                            <div class="tree-node-stat">
                                <div class="tree-node-stat-label">ç”¨æˆ·ID</div>
                                <div class="tree-node-stat-value">#${user.id}</div>
                            </div>
                        </div>
                    </div>
                `;

                if (user.children && user.children.length > 0 && level < 3) {
                    html += '<div class="tree-children">';
                    user.children.forEach((child, index) => {
                        html += '<div class="tree-branch">';
                        html += buildTreeNode(child, level + 1);
                        html += '</div>';
                    });
                    html += '</div>';
                }

                return html;
            }

            tree.innerHTML = statsHtml + '<div class="tree-container">' + buildTreeNode(data.user) + '</div>';
        }

        // æŸ¥çœ‹ç™»å½•è®°å½•
        async function viewLoginLog(userId) {
            document.getElementById('loginLogModal').style.display = 'block';
            document.getElementById('loginLogList').innerHTML = '<div style="text-align: center; padding: 40px; color: #8c8c8c;">åŠ è½½ä¸­...</div>';

            try {
                // ç™»å½•æ—¥å¿—APIéœ€è¦ç¡®è®¤åç«¯è·¯ç”±
                const result = { code: 1, data: [] }; // æš‚æ—¶è¿”å›ç©ºæ•°æ®

                if (result.code === 1 && result.data && result.data.length > 0) {
                    let html = '';
                    result.data.forEach(log => {
                        html += `
                            <div class="login-log-item">
                                <div>
                                    <div class="time">${formatDateTime(log.login_time)}</div>
                                    <div class="device">
                                        ${log.device_type || 'æœªçŸ¥è®¾å¤‡'} | IP: ${log.login_ip || 'æœªçŸ¥'}
                                        ${log.login_status == 1 ? '<span class="badge badge-success">æˆåŠŸ</span>' : '<span class="badge badge-danger">å¤±è´¥</span>'}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    document.getElementById('loginLogList').innerHTML = html;
                } else {
                    document.getElementById('loginLogList').innerHTML = '<div style="text-align: center; padding: 40px; color: #8c8c8c;">æš‚æ— ç™»å½•è®°å½•</div>';
                }
            } catch (error) {
                document.getElementById('loginLogList').innerHTML = '<div style="text-align: center; padding: 40px; color: #ff4d4f;">åŠ è½½å¤±è´¥</div>';
            }
        }

        // å¯¼å‡ºç”¨æˆ·
        function exportUsers() {
            alert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN');
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) {
                window.location.href = '/login.html';
            }
        }
    </script>
        </div><!-- /container -->
    </div><!-- /content-wrapper -->
</div><!-- /layout -->
</body>
</html>
